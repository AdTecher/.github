name: PR Standards

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write

jobs:
  check-standards:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR compliance
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const checks = [];
            let allPassed = true;

            // Check 1: PR description length
            const bodyLength = (pr.body || '').replace(/<!--[\s\S]*?-->/g, '').trim().length;
            const descPass = bodyLength > 50;
            checks.push(`${descPass ? '[PASS]' : '[FAIL]'} Description length: ${bodyLength} chars (min 50)`);
            if (!descPass) allPassed = false;

            // Check 2: Linked issue
            const issuePattern = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#\d+/i;
            const hasIssueRef = pr.body && issuePattern.test(pr.body);
            checks.push(`${hasIssueRef ? '[PASS]' : '[WARN]'} Linked issue: ${hasIssueRef ? 'found' : 'none detected'}`);

            // Check 3: Branch naming convention
            const branchPattern = /^(feature|fix|chore|docs)\//;
            const branchPass = branchPattern.test(pr.head.ref);
            checks.push(`${branchPass ? '[PASS]' : '[FAIL]'} Branch naming: "${pr.head.ref}" (expected feature/fix/chore/docs prefix)`);
            if (!branchPass) allPassed = false;

            // Check 4: Conventional commit in title
            const commitPattern = /^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?!?:/;
            const titlePass = commitPattern.test(pr.title);
            checks.push(`${titlePass ? '[PASS]' : '[FAIL]'} Conventional commit title: "${pr.title}"`);
            if (!titlePass) allPassed = false;

            const status = allPassed ? 'All checks passed.' : 'Some checks failed. Please review.';
            const body = [
              '## PR Standards Check',
              '',
              ...checks,
              '',
              `**Status:** ${status}`,
              '',
              '---',
              '*Automated check by [AdTecher PR Standards](https://github.com/AdTecher/.github)*'
            ].join('\n');

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });
            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('PR Standards Check')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body,
              });
            }

            if (!allPassed) {
              core.setFailed('PR does not meet standards.');
            }
